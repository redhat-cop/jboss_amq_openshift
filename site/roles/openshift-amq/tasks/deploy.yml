---
- name: Create OpenShift namespace
  k8s:
    name: "{{ openshift_namespace }}"
    api_version: v1
    kind: namespace
    state: present

- name: Create OpenShift service account
  k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: "{{ openshift_service_account }}"
        namespace: "{{ openshift_namespace }}"

- name: Add OpenShift view role to service account
  k8s:
    state: present
    definition:
      apiVersion: authorization.openshift.io/v1
      kind: RoleBinding
      groupNames: null
      metadata:
        name: view
        namespace: "{{ openshift_namespace }}"
      roleRef:
        name: view
      subjects:
        - kind: ServiceAccount
          name: "{{ openshift_service_account }}"
          namespace: "{{ openshift_namespace }}"
      userNames:
        - "system:serviceaccount:{{ openshift_namespace }}:{{ openshift_service_account }}"

- name: Check if already deployed
  command:
    oc get dc broker-amq -n {{ openshift_namespace }}
  register: amq_dc
  ignore_errors: yes
  failed_when: False
  no_log: True

- name: Generate OpenShift parameters needed for deployment
  template:
    src: openshift-process-parameters.j2
    dest: "{{ cert_dir.path }}/env"

- name: Deploy
  shell: >
    oc process openshift//amq63-ssl -o yaml --param-file={{ cert_dir.path }}/env | oc create -f - -n {{ openshift_namespace }}
  when: amq_dc.rc != 0

- name: Retrieve deployment configuration
  command: >
    oc get dc broker-amq -o yaml -n {{ openshift_namespace }}
  register: amq_dc

- name: Update deployment configuration to include service account
  k8s:
    state: present
    definition:
      apiVersion: apps.openshift.io/v1
      kind: DeploymentConfig
      metadata:
        name: broker-amq
        namespace: "{{ openshift_namespace }}"
        spec:
          template:
            metadata:
              name: broker-amq
              spec:
                serviceAccount: "{{ openshift_service_account }}"
                serviceAccountName: "{{ openshift_service_account }}"

- name: Generate OpenShift secrets from key store ---- TODO TRY k8s APPROACH
  shell: >
    oc secrets new amq-app-secret {{ cert_dir.path }}/{{ amq_keystore }} {{ cert_dir.path }}/{{ amq_truststore }} -n {{ openshift_namespace }}

- name: Add secrets to OpenShift service account ---- TODO try k8s APPROACH
  shell: >
    oc secrets add sa/{{ openshift_service_account }} secret/amq-app-secret -n {{ openshift_namespace }}

- name: Expose secured STOMP route
  k8s:
    state: present
    definition:
      apiVersion: route.openshift.io/v1
      kind: Route
      metadata:
        labels:
          application: broker
          template: amq63-ssl
          xpaas: 1.4.14
        name: stomp
        namespace: "{{ openshift_namespace }}"
      spec:
        tls:
          termination: passthrough
        to:
          kind: Service
          name: broker-amq-stomp-ssl
          weight: 100
        wildcardPolicy: None
